# 第8章
* 8.1 概述
    * xv6文件系统实现分为7层，从上到下，文件描述符（file descriptor），路径名（pathname），目录（directory），索引节点（inode），日志（logging）缓冲区高速缓存（buffer cache），磁盘（disk）。
    * 文件系统的结构
        * 结构
            * ![文件系统的结构](images/文件系统的结构.png)

            * 块1位超级块：包含有关文件系统的元数据（文件系统的大小，数据块大小，日志块大小，索引节点数等）
            * 块2 开始时日志块，用于故障恢复。xv6的日志使用30个块
            * 日志块的后面位索引节点，和位图，数据区域
* 8.2 缓冲区缓存
    * 缓存去缓存的两个任务
        * 同步对磁盘块的访问，确保磁盘块在内存中只有一个副本，并且一次只有一个内核线程使用该副本。
        * 缓存常用块，以便不需要从慢速磁盘中重新读区。
        
* 8.3 代码： Buffer cache
    * 示意图
        * ![buffer cache](images/缓冲区缓存.png)
    * 代码的实现未做具体详述，课参考[该网页](http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/c8/s3.html)

* 8.4 日志层
    * 日志系统的目的是能够有故障恢复功能。
    * 当发生故障时，如果日志中有记录，则在重新启动系统时执行日志中的内容。
    * 日志中有提交点，只有在提交之后才会记录到日志块当中，否则就当作没有发生过时事情。

* 8.5 日志设计
    * 日志由头块和一些列更新块的副本组成。在头块中记录日志中保存的块的个数与扇区号，用于故障恢复。
    * 只有commit时才会将日志块的副本更新到相应的数据块中。
    * ![日志数据结构](images/日志数据结构.png)
    * ![日志执行过程](images/日志执行过程.png)
    * 写入序列必须具有原子性
    
* 8.6 代码：日志
    * 系统调用中典型的日志使用
        * 
        ```
        begin_op()
        bp = bread()
        bp-> data[...] = ...
        log_write()
        ...
        end_op()
        ```
    
* 8.8  索引节点层
    * inode包含两种含义，可能是包含文件大小，数据块编号和磁盘上的数据结构，或者是内存中的inode，包含磁盘上的inode副本以及内核所需的额外信息。
    * 磁盘上的inode

    * 内存上的inode
