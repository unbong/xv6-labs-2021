# 第5章 中断与设备驱动
* 总览
    * 驱动程序管理着特别的设备，并配置硬件，通知设备如何执行操作，并处理中断的结果，然后与等待I/O设备的进程进程进行交互。
    * 设备需要获取操作系统的注意，通常被配置为生成中断（陷阱的一种类型）内核的陷阱处理程序识别，并调用驱动的中断处理程序。
    * 设备驱动代码在两个盛夏问中执行。
        * 上半部分，在内核的线程中。
        * 下半部分，在中断时间执行。

* 5.1 代码：控制台输入 
    * 生产者消费者模式的一种应用
        * 生产者：敲击键盘的事件
            * 敲击键盘时UART产生中断，并用UART的uartintr(中断处理程序处理)该中断。uartintr循环读取寄存器RHR中的一个字节数据，并将该数据传递给consoleintr程序处理，consoleintr程序将一个字节的数据存储到cons.buf的队列中，如果接受的是一行结束的字符，则将唤醒读取cons.buf的进程。

        * 消费者：
            * 在用户程序的read系统调用，会进入到监视者模式的read系统调用函数中，该函数根据传递的文件描述符（在这里是标准输入：0）去读取相应的数据，此时会调用consoleread函数。consoleread函数，循环读取cons.buf队列中的数据，并将读取的数据复制到用户模式中。读取队列中不存在数据时，则进程进入睡眠，等待生产者唤醒。

    * 5.2  代码： 控制台输出
        * 生产者消费者模式的一种应用
            * 生产者
                * write系统调用（文件描述符为1：标准输出），会调用consolewrite，最终会调用uartputc函数。uartputc函数会将一个字符保存在一个队列中。当队列满时使进程睡眠。
            * 消费者
                * 每当UART完成一个字节的传输，它会生成一个中断，uartintr中断处理程序会调用uartstart循环冲uart_tx_buf队列中读取一个字符，先唤醒生产者的进程，并写入到THR寄存器中，该寄存器如果有值，UART会将传输该字节。

    * 5.3 驱动中的并发
        * 需要使用锁来保护驱动中的数据结构。
        * 

    * 5.4 时间中断
        * 时间中断设备会生成一个中断，该中断由timmervec中断处理程序接受并处理，该处理程序，会保存相关寄存器的值，并设定下一次中断间隔时间，并产生程序中断，并使其进入到usertrap或kerneltrap函数中。使其能够被处理。在devintr中判断为时间中断后，usertrap或kerneltrap会执行yield函数，进行上下文切换。

    * 5.5 
        * DMA（direct memory access） 设备直接将数据写入到内存。可以更加快速的读写数据。
        
    